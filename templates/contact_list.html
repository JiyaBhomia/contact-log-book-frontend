<h2>My Contacts</h2>
<a href="{% url 'contact_create' %}">Add New Contact</a> | <a href="{% url 'logout' %}" id="logout-button">Logout</a>
<hr>

<ul id="contact-list-container">
    <li>Loading contacts...</li>
</ul>

<script>
    function checkTokenAndFetch() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            window.location.href = "{% url 'login' %}";
            return;
        }
        fetchContacts(accessToken);
    }

    async function fetchContacts(token) {
        const container = document.getElementById('contact-list-container');
        try {
            const response = await fetch('http://127.0.0.1:8001/api/contacts/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401) {
                localStorage.removeItem('accessToken');
                window.location.href = "{% url 'login' %}";
                return;
            }

            const contacts = await response.json();
            container.innerHTML = ''; 

            if (contacts.length === 0) {
                container.innerHTML = '<li>You have no contacts yet.</li>';
                return;
            }

            contacts.forEach(contact => {
                const li = document.createElement('li');
                // Use the Django URL tags to build the correct paths
                const editUrl = "{% url 'contact_update' 9999 %}".replace('9999', contact.id);
                const deleteUrl = "{% url 'contact_delete' 9999 %}".replace('9999', contact.id);
                
                li.innerHTML = `
                    <strong>${contact.name}</strong> (${contact.email})
                    <a href="${editUrl}">Edit</a>
                    <a href="${deleteUrl}">Delete</a>
                `;
                container.appendChild(li);
            });
        } catch (error) {
            console.error('Error fetching contacts:', error);
            container.innerHTML = '<li>Could not load contacts. Is the backend server running?</li>';
        }
    }

    document.getElementById('logout-button').addEventListener('click', function(event) {
        event.preventDefault(); // Stop the link
        localStorage.removeItem('accessToken'); // Clear the token
        window.location.href = this.href; // Now go to the logout page
    });

    document.addEventListener('DOMContentLoaded', checkTokenAndFetch);
</script>